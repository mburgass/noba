#biodiversity indicators 24/11/2015 Emily Nicholson
========================================================

## Species and analyses
To generate a 'true (model)' RLI and LPI, we are planning to get all the species associated with each FG as described in the model documentation. We will then match these for the 'current' RLI and LPI species.  

For the RLI, we need the species to be linked to a FG to generate trends, a current threat RL status (or inferred), and a generation length for assessment.

For the LPI, we need only biomass trends (ie relative change in abundance or biomass).  

For MTI, we need trophic levels and biomass, both of which are generated from the model, from inputs (based on analyses and fishbase records). 

### to do
get all LMEs into the right format  
develop a for loop to run through LMEs for a test run (with old input data)  
Generate output files
Do plots at the end  
uncertainty in RLI  

North Sea: go through all the species to double check Hayley's work, esp allocate uncertain spp to fgs


### Create a data frame - probably don't need to do this - not done yet so ignore
Create a data.frame to store for each model/LME:  
data: species, functional groups, 
Ecopath data per scenario(x2): biomass/km2, trophic level, catch/km2, landings/km2
analyses: rlicalc
results(x4: scen TL): rli, mti, lpi


```{r setup}
library(rdatacite)
library(taxize)
library(letsR) #this isn't working for my species lists?
library(rfishbase)
library(ggplot2)
library(dplyr)
library(plyr)
library(rredlist)
install.packages("devtools")
library(devtools)
# Install from main ZSL repository online
#install_github("Zoological-Society-of-London/rlpi", dependencies=TRUE)
library(rlpi) 

setwd("~/Documents/Papers in progress/Fisheries indicators/2014analyses/fisheries-indicators-Nov2014")

lme<-list("NthSea","Aleutians","Benguela","GulfCalif","China","GBR","Florida","NthAdriatic")
#make a list? either now or at the end
#template <- data.frame that I need to work out the structure for
#ll<-as.list(b0,b50,c0,c50)
#lme[[1]]<-ll
#str(lme[1])
#lme[1]<-list(b0=b0,b50=b50,c0=c0,c50=c50)
#is.list(lme)
#lme[1]<-b0
#nthsea["b0"",]

```


### Bring in data:  
1 species list  
2 functional group lists  
3 Ecopath scenarios   
  (no fg names, rows=fg by number, col=years starting at yr20 of simulation @policy implementation, transformed from ecopath output)  
1 biomass (EwE6-Ecosim_annual_biomass.csv  
2 trophic level (EwE6-Ecosim_annual_TL.csv)  
3 catch (EwE6-Ecosim_annual_yield.csv)  
4 landings (from files Alberto modified and sent: Landings discards areas 020513eveningAB-1)  

```{r import data}

m<-4
lme[m]


spp <- read.csv(file=paste0(lme[m],"/species_fin_13July17.csv")) 
table(spp$RLstatus)

fg <- read.csv(file=paste0(lme[m],"/functionalgroups.csv"))
# columns needed are named: fg  spp	RLI	RLstatus	GenLength	LPI
#spp$RLI<-spp$RLI*1
spp$RLI<-as.numeric(as.character(spp$RLI))
  #sum(spp$RLI, na.rm = TRUE)
spp$RLI[is.na(spp$RLI)]<-0  #d[is.na(d)] <- 0
spp$LPI<-as.numeric(as.character(spp$LPI))
  #sum(spp$LPI, na.rm = TRUE)
spp$LPI[is.na(spp$LPI)]<-0  #d[is.na(d)] <- 0

#see previous versions of file imports in Indicators24112015
#Biomass, catch, landings and trophic lengths per functional group, from Ecopath
startyear<-21 #this means starting at year 20, year before implementation

b0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_biomass.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  b0 <- b0[-nrow(b0),] #need to delete last row - an extra one is in the csv file
b50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_biomass.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  b50 <- b50[-nrow(b50),] #need to delete last row - an extra one is in the csv file
  
c0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_yield.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  c0 <- c0[-nrow(c0),] #need to delete last row - an extra one is in the csv file
c50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_yield.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  c50 <- c50[-nrow(c50),] #need to delete last row - an extra one is in the csv file

l0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/landings.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  #l0 <- l0[-nrow(l0),] #need to delete last row - an extra one is in the csv file
l50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/landings.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  #l50 <- l50[-nrow(l50),] #need to delete last row - an extra one is in the csv file

tl0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_TL.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  tl0 <- tl0[-nrow(tl0),] #need to delete last row - an extra one is in the csv file
tl50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_TL.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  tl50 <- tl50[-nrow(tl50),] #need to delete last row - an extra one is in the csv file  

#write.table(tl0, file=paste0(lme[m],"/","tl0.csv"), sep=",", row.names = FALSE, col.names=FALSE)
#sum(l0-c0)

```



##Calculate MTIs
Currently models MTI with min TL 3.25 (as recommended in a paper), can also be 2, but I haven't done it for both.

NEXT THING TO DO: 2 separate bits for MTI2 and MTI 3.25  
Find a better way to deal with the data

Can just run this from the FG file, not the species file, as the influence of a species is not the number of populations sampled but its biomass within the system.

```{r MTI}
# works! Calculates the MTI.

tlmin <- 3.25  #this is the minimum Trophic Level to me included in the MTI
#tlmin <- 2
mti.b0 <- 
    colSums(b0*tl0*(tl0>=tlmin)*fg[,"Include.in.MTI."])/colSums(b0*(tl0>=tlmin)*fg[,"Include.in.MTI."])
mti.l0 <- 
    colSums(l0*tl0*(tl0>=tlmin)*fg[,"Include.in.MTI."])/colSums(l0*(tl0>=tlmin)*fg[,"Include.in.MTI."])
mti.c0 <- 
    colSums(c0*tl0*(tl0>=tlmin)*fg[,"Include.in.MTI."])/colSums(c0*(tl0>=tlmin)*fg[,"Include.in.MTI."])
#this is the MTI of biomass of landed species, not sure this is right though
mti.bl0 <- 
    colSums(b0*tl0*(tl0>=tlmin)*fg[,"LandedSpp"])/colSums(b0*(tl0>=tlmin)*fg[,"LandedSpp"])
mti.b50 <- 
    colSums(b50*tl50*(tl50>=tlmin)*fg[,"Include.in.MTI."])/colSums(b50*(tl50>=tlmin)*fg[,"Include.in.MTI."])
mti.l50 <- 
    colSums(l50*tl50*(tl50>=tlmin)*fg[,"Include.in.MTI."])/colSums(l50*(tl50>=tlmin)*fg[,"Include.in.MTI."])
mti.c50 <- 
    colSums(c50*tl50*(tl50>=tlmin)*fg[,"Include.in.MTI."])/colSums(c50*(tl50>=tlmin)*fg[,"Include.in.MTI."])

mini <- min(mti.b0, mti.b50)
maxi <- max(mti.l50, mti.l0, mti.c50, mti.c0)
plot(mti.b0, ylim=c(mini,maxi), xlim=c(0,40), type="l",col="black", ann=FALSE)
  lines(mti.l0,col="red")
  lines(mti.c0,col="blue")
  lines(mti.bl0,lty=2,col="grey")
  lines(mti.b50,lty=2,col="black")
  lines(mti.l50,lty=2, col="red")
  lines(mti.c50,lty=2, col="blue")
  title(ylab="MTI", xlab="Years")

mini <- min(-0.03)
maxi <- max(0.03)
plot((mti.b0-mti.b0[1])/mti.b0[1],ylim=c(mini,maxi), xlim=c(0,40), type="l",col="black", ann=FALSE,lwd=2)
  lines((mti.l0-mti.l0[1])/mti.l0[1],col="red", lwd=2)
  lines((mti.c0-mti.c0[1])/mti.c0[1],col="blue", lwd=2)
  #lines((mti.b50-mti.b50[1])/mti.b50[1],lty=2,col="black")
    #lines((mti.bl0-mti.bl0[1])/mti.bl0[1],lty=2,col="grey")
  #lines((mti.l50-mti.l50[1])/mti.l50[1],lty=2, col="red")
  #lines((mti.c50-mti.c50[1])/mti.c50[1],lty=2, col="blue")
  title(ylab="Proportional change in MTI", xlab="Years")

```


##RLI
Red List Index:
Gives a 'true' (all species) RLI and a 'sampled' RLI for the two scenarios (halt bottom trawling in solid lines, halving in dashed lines, where true=black and sample in red)

This currently just does mean inferred trends from RL status.
Need to add:
- uncertainty around inferred declines from status
- uncertainty from inferred status
- uncertainty from inferred generation length
- uncertainty for DD and NE species (and what status assumed to be)

**what threat status do we give to not-yet-redlisted species? That affects our starting point for the RLI values.
**can we use OHI code to pull range maps from the IUCN site to get the IUCN species as a starting list? Might add a few more species.
**can you get generation length via R from the IUCN website? Rather than the excel spreadsheet? Can we do the same from LPI to make it super up to date?



```{r RLI}
#use the colums in spp to include or exclude in RLI and LPI

timeframe <- pmax(10, pmin(round(3*spp$GenLength),100))   #asssessment timeframe
nspp<-length(spp$spp)#number of species
RL.0<-array(data = 0, dim = c(5,nspp))  #array to store the RL values per species, halting trawling
RL.0[1,] <- ifelse(spp$RLstatus=="CR",4,ifelse(spp$RLstatus=="EN",3,ifelse(spp$RLstatus=="VU",2,ifelse(spp$RLstatus=="NT",1,0))))

RL.50<-array(data = 0, dim = c(5,nspp))
RL.50[1,] <- ifelse(spp$RLstatus=="CR",4,ifelse(spp$RLstatus=="EN",3,ifelse(spp$RLstatus=="VU",2,ifelse(spp$RLstatus=="NT",1,0))))

#inferred median/mean? annual declines based on RL status 
InfDecl <- ifelse(RL.0[1,]==4,-0.9,ifelse(RL.0[1,]==3,-0.65,ifelse(RL.0[1,]==2,-0.4,ifelse(RL.0[1,]==1,-0.25,0))))/timeframe
  #only needs one as starting status is the same for both scenarios

#===================================
# new species-based loop for RL status, needed as assessment year ie column) changes per species
for (i in 1:4) {
  #i<-1
  year<-i*10 #decadal intervals
  Btime0<-b0[spp$fg,year+1]  #Biomass at decadal intervals
  Btime50<-b50[spp$fg,year+1]
  for (sp in 1:nspp) {   
    #this calculates the decline over the species-specific timeframe based on generation length, and inferred decline from RL status 
    if (timeframe[sp]>year) {
    InfBstart <- b0[spp$fg,1][sp]/(1+InfDecl[sp]*(timeframe[sp]-year))
    Declat0 <- (Btime0[sp]-InfBstart)/InfBstart 
    Declat50 <- (Btime50[sp]-InfBstart)/InfBstart 
    } else {
    Bstart0 <- b0[spp$fg,year+1-timeframe[sp]][sp]
    Declat0 <- (Btime0[sp]-Bstart0)/Bstart0
    Bstart50 <- b50[spp$fg,year+1-timeframe[sp]][sp]
    Declat50 <- (Btime50[sp]-Bstart50)/Bstart50
    }
  RL.0[i+1,sp]<-ifelse(Declat0<=-0.8,4,ifelse(Declat0<=-0.5,3,ifelse(Declat0<=-0.3,2,ifelse(Declat0<=-0.2,1,0)))) #this estimates the RL status based on decline (ignoring other criteria)
  RL.50[i+1,sp]<-ifelse(Declat50<=-0.8,4,ifelse(Declat50<=-0.5,3,ifelse(Declat50<=-0.3,2,ifelse(Declat50<=-0.2,1,0))))
  }
}

#RLI ===================
RLIs<-c("true.0","true.50","sample.0", "sample.50")
RLI <- array(dim=c(length(RLIs),5))
rownames(RLI)<-RLIs
RLI["true.0",] <-1-(rowSums(RL.0)/(nspp*5))  #calculates the RLI 
RLI["true.50",] <-1-(rowSums(RL.50)/(nspp*5))

RLI["sample.0",] <-1-rowSums(RL.0[,spp$RLI==1])/(sum(spp$RLI)*5)
RLI["sample.50",] <-1-rowSums(RL.50[,spp$RLI==1])/(sum(spp$RLI)*5)

plot(RLI["true.0",], ylim=c(min(RLI),max(RLI)), type="l",col="black", ann=FALSE)
  lines(RLI["true.50",],lty=2,col="black")
  lines(RLI["sample.0",],col="red")
  lines(RLI["sample.50",],lty=2,col="red")
  title(ylab="RLI", xlab="Years")

```


##LPI

A species forms a LPI time-series. The 'true' LPI uses a larger set of species (includes verts and inverts but can be readily changed!), while the sampled LPI is based on the subset of species currently sampled by the LPI

```{r LPI}

years <- ncol(b0)

spp.LPI.0<-spp[,c("spp","fg","LPI")]
spp.LPI.0[,(ncol(spp.LPI.0)+1):(years+ncol(spp.LPI.0))]<- b0[spp.LPI.0$fg,]
spp.sampleLPI.0 <- spp.LPI.0[spp.LPI.0$LPI==1,]

spp.LPI.50<-spp[,c("spp","fg","LPI")]
spp.LPI.50[,(ncol(spp.LPI.50)+1):(years+ncol(spp.LPI.50))]<- b50[spp.LPI.50$fg,]
spp.sampleLPI.50 <- spp.LPI.50[spp.LPI.50$LPI==1,]

LPIs<-c("true.0","true.50","sample.0", "sample.50")
LPI <- array(dim=c(length(LPIs),years))
rownames(LPI)<-LPIs

LPI[,1]<-1  #each LPI starts at 1

#Calculating the LPI, starting in y2, because y1=1
for (y in 2:years) {
  yy<- y+3  #change this if more columns before biomass values start
  
  LPI["true.0",y] <-LPI["true.0",y-1]*(10^(mean(log10(spp.LPI.0[,yy])-log10(spp.LPI.0[,yy-1]))))
  LPI["true.50",y] <-LPI["true.50",y-1]*(10^(mean(log10(spp.LPI.50[,yy])-log10(spp.LPI.50[,yy-1]))))
  LPI["sample.0",y] <-LPI["sample.0",y-1]*(10^(mean(log10(spp.sampleLPI.0[,yy])-log10(spp.sampleLPI.0[,yy-1]))))
  LPI["sample.50",y] <-LPI["sample.50",y-1]*(10^(mean(log10(spp.sampleLPI.50[,yy])-log10(spp.sampleLPI.50[,yy-1]))))

  }



# plot =====================================

plot(LPI[1,], ylim=c(min(LPI),max(LPI)), xlim=c(0,40), type="l",col="black", ann=FALSE)
  lines(LPI[2,],lty=2,col="black")
  lines(LPI[3,],lty=1,col="red") #one rep per FG
  lines(LPI[4,],lty=2,col="red") #one rep per FG
  title(ylab="LPI", xlab="Years")


  
```
Black is 'true' LPI, or as close as possible, with each species mentioned in the model documentation, versus one represenatative per functional group. The difference lies in the number of times each FG is sampled, with black being closer to representative of the number of species in each group.  


```{r summary by threat}

#proportion change in catch?
(sum(c0[,10])-sum(c0[,1]))/sum(c0[,1])

LME<-lme[m]
nspp<-length(spp$spp) 
nfgs<-length(fg$FGnum)
LPIspp<-sum(spp$LPI)
  LPIfgs.list<- aggregate(spp$LPI, by = list(fg = spp$fg), FUN = sum, na.rm=TRUE)
LPIfgs <- sum(LPIfgs.list$x>0)
RLIspp<-sum(spp$RLI)
  RLIfgs.list<- aggregate(spp$RLI, by = list(fg = spp$fg), FUN = sum, na.rm=TRUE)
RLIfgs<-sum(RLIfgs.list$x>0)

table(spp$RLstatus)

table(spp$fg[spp$RLI==1])
table(spp$fg[spp$RLstatus=="CR"])
table(spp$fg[spp$RLstatus=="EN"])
table(spp$fg[spp$RLstatus=="VU"])
table(spp$fg[spp$LPI==1])

table(RL.0.sample[,1])
table(RL.0.sample[,2])
table(RL.0.sample[,3])
table(RL.0.sample[,4])
table(RL.0.sample[,5])

worsespp<-spp[(RL.0[,2]>RL.0[,1])*1==1,]
RL.0.sample["272",]
spp[21,]

#=== plot trends by threat level ========
#biomasstrends<-b0/b0[,1]

(b0/b0[,1]<0.7)*1
    

CRspp<-as.integer(rownames(table(spp$fg[spp$RLstatus=="CR"])))
  CRtrends<-b0[CRspp,]/b0[CRspp,1]
    rownames(CRtrends)<-rownames(table(spp$fg[spp$RLstatus=="CR"]))
  CRtrends["mean",]<-colMeans(CRtrends)
  nCR<-length(CRtrends$V1)-1
  plot(c(1:50),CRtrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=1, ann=FALSE)
    cl <- rainbow(nCR)
    for (i in 1:nCR){lines(c(1:50),CRtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(CRtrends[1:nCR,]), pch=3 , col=cl, bty='n')  
ENspp<-as.integer(rownames(table(spp$fg[spp$RLstatus=="EN"])))
  ENtrends<-b0[ENspp,]/b0[ENspp,1]
    rownames(ENtrends)<-rownames(table(spp$fg[spp$RLstatus=="EN"]))
  ENtrends["mean",]<-colMeans(ENtrends)
  nEN<-length(ENtrends$V1)-1
  plot(c(1:50),ENtrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=1, ann=FALSE)
    cl <- rainbow(nEN)
    for (i in 1:nEN){lines(c(1:50),ENtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(ENtrends[1:nEN,]), pch=3 , col=cl, bty='n') 
VUspp<-as.integer(rownames(table(spp$fg[spp$RLstatus=="VU"])))
  VUtrends<-b0[VUspp,]/b0[VUspp,1]
    rownames(VUtrends)<-rownames(table(spp$fg[spp$RLstatus=="VU"]))
  VUtrends["mean",]<-colMeans(VUtrends)
  nVU<-length(VUtrends$V1)-1
  plot(c(1:50),VUtrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=1, ann=FALSE)
    cl <- rainbow(nVU)
    for (i in 1:nVU){lines(c(1:50),VUtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(VUtrends[1:nVU,]), pch=3 , col=cl, bty='n') 

plot(c(1:50),(b0[3,]/b0[3,1]), ylim=c(0.8,1.1), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE) #birds
  lines (c(1:50),(b0[12,]/b0[12,1]),lty=1,col="green") #sandeels
  lines (c(1:50),(b0[23,]/b0[23,1]),lty=1,col="red") #discards  
  #lines (c(1:50),(b0[26,]/b0[26,1]),lty=1,col="blue") #zooplankton
  lines (c(1:50),(b0[4,]/b0[4,1]),lty=1,col="lightblue") #zooplankton    
  lines (c(1:50),(b0[11,]/b0[11,1]),lty=1,col="orange") #zooplankton    
    legend("bottomright", inset=c(0,0), legend=c("seabirds","Clupaeidae","Squid","Other fish" ), pch=3 , col=c("black", "green","lightblue", "orange"), bty='n') 
  

```

 
 
 
```{r summary data}

# system, number of FGs, species, species in LPI, FGs in LPI, species in RLI, FGs in RLI, in MTI

tlmin <- 3.25
trueMTIfgs<-sum(fg$Include.in.MTI.*(fg$TL>=tlmin))
#landedMTIfgs<-sum(fg$LandedSpp*(fg$TL>=tlmin))
catchMTIfgs0<-sum((c0[3]>0)*(tl0[1]>=tlmin)*fg[,"Include.in.MTI."])
landedMTIfgs0<-sum((l0[3]>0)*(tl0[1]>=tlmin)*fg[,"Include.in.MTI."])

catchMTIfgs50<-sum((c50[3]>0)*(tl50[1]>=tlmin)*fg[,"Include.in.MTI."])
landedMTIfgs50<-sum((l50[3]>0)*(tl50[1]>=tlmin)*fg[,"Include.in.MTI."])

summarystats<-data.frame(LME,nspp,nfgs, LPIspp, LPIfgs, RLIspp, RLIfgs, trueMTIfgs, landedMTIfgs0, landedMTIfgs50,catchMTIfgs0,catchMTIfgs50)

table(spp$RLstatus)
# which functional groups are sampled? NOT FINISHED
#LPI.fgs<-unique(spp.sampleLPI.0$fg)
#Fgspp<-table(spp$fg)

#match name to FG, then add how many of each group there is
IndicatorFGS <- aggregate(spp$LPI, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    names(IndicatorFGS)[names(IndicatorFGS) == 'x'] <- 'LPI'
  RLIFGS <- aggregate(spp$RLI, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$RLI<-RLIFGS$x
  ModelFGS <- aggregate(spp$model, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$model<-ModelFGS$x
  allFGS <- aggregate(spp$model, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$model<-ModelFGS$x    
fg.indicators<-merge(fg, IndicatorFGS,  by.x='FGnum', by.y='fg', all.x=TRUE)


# plot trends by taxonomic group ========================
spp$bird <- fg$Birds[match(spp$fg,fg$FGnum)]
spp$fish <- fg$TeleostFish[match(spp$fg,fg$FGnum)]
spp$mammal <- fg$Mammals[match(spp$fg,fg$FGnum)]
spp$sharksrays <- fg$Elasmobranchs[match(spp$fg,fg$FGnum)]
spp$inverts <- fg$InvertsPlants[match(spp$fg,fg$FGnum)]

IndicatorGroups<-data.frame() #(all = 0, RLI = 0, LPI = 0, model = 0)
IndicatorGroups["bird","all"]<-sum(spp$bird)
  IndicatorGroups["bird","LPI"]<-sum(spp$bird*spp$LPI)
  IndicatorGroups["bird","RLI"]<-sum(spp$bird*spp$RLI)
  IndicatorGroups["bird","model"]<-sum(spp$bird*spp$model)
  IndicatorGroups["bird","fgs"]<-sum(fg$Birds)
IndicatorGroups["mammal",1:5]<-c(sum(spp$mammal),sum(spp$mammal*spp$LPI),sum(spp$mammal*spp$RLI), sum(spp$mammal*spp$model),sum(fg$Mammals)) 
IndicatorGroups["fish",1:5]<-c(sum(spp$fish),sum(spp$fish*spp$LPI),sum(spp$fish*spp$RLI), sum(spp$fish*spp$model),sum(fg$TeleostFish)) 
IndicatorGroups["sharksrays",1:5]<-c(sum(spp$sharksrays),sum(spp$sharksrays*spp$LPI),sum(spp$sharksrays*spp$RLI), sum(spp$sharksrays*spp$model),sum(fg$Elasmobranchs)) 
IndicatorGroups["inverts",1:5]<-c(sum(spp$inverts),sum(spp$inverts*spp$LPI),sum(spp$inverts*spp$RLI), sum(spp$inverts*spp$model),sum(fg$InvertsPlants)) 

barplot(as.matrix(t(IndicatorGroups[,1:3])), cex.lab = 1.5, cex.main = 1.4, beside=TRUE, horiz=TRUE, col=c("black","green", "red")) #red for RLI, green for LPI, black for all
#barplot(as.matrix(t(IndicatorGroups[,1:3])), cex.lab = 1.5, cex.main = 1.4, horiz=TRUE, col=c("black","green", "red"))

#biomass change yr40 relative to y1 for Fgs in this group
#IndicatorGroups["bird","changeB"]<-sum(spp$bird)

#df <- data.frame(x=rep(1:5, 9), val=sample(1:100, 45), 
                  # variable=rep(paste0("category", 1:9), each=5))
Birdtrends<-b0[fg$Birds==1,]/b0[fg$Birds==1,1]
    rownames(Birdtrends)<-fg$Functional.group[fg$Birds==1]
  Birdtrends["mean",]<-colMeans(b0[fg$Birds==1,]/b0[fg$Birds==1,1])
  nbirds<-length(Birdtrends$V1)-1
  plot(c(1:50),Birdtrends["mean",], ylim=c(0.5,1.2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nbirds)
    for (i in 1:nbirds){lines(c(1:50),Birdtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Birdtrends[1:nbirds,]), pch=3 , col=cl, bty='n')  

Mammaltrends<-b0[fg$Mammals==1,]/b0[fg$Mammals==1,1]
    rownames(Mammaltrends)<-fg$Functional.group[fg$Mammals==1]
  Mammaltrends["mean",]<-colMeans(b0[fg$Mammals==1,]/b0[fg$Mammals==1,1])
  nmammals<-length(Mammaltrends$V1)-1
  plot(c(1:50),Mammaltrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nmammals)
    for (i in 1:nmammals){lines(c(1:50),Mammaltrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Mammaltrends[1:nmammals,]), pch=3 , col=cl, bty='n')  
  
Fishtrends<-b0[fg$TeleostFish==1,]/b0[fg$TeleostFish==1,1]
    rownames(Fishtrends)<-fg$Functional.group[fg$TeleostFish==1]
  Fishtrends["mean",]<-colMeans(b0[fg$TeleostFish==1,]/b0[fg$TeleostFish==1,1])
  nfish<-length(Fishtrends$V1)-1
  plot(c(1:50),Fishtrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nfish)
    for (i in 1:nfish){lines(c(1:50),Fishtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Fishtrends[1:nfish,]), pch=3 , col=cl, bty='n')  

Sharkraytrends<-b0[fg$Elasmobranchs==1,]/b0[fg$Elasmobranchs==1,1]
    rownames(Sharkraytrends)<-fg$Functional.group[fg$Elasmobranchs==1]
  Sharkraytrends["mean",]<-colMeans(b0[fg$Elasmobranchs==1,]/b0[fg$Elasmobranchs==1,1])
  nsharks<-length(Sharkraytrends$V1)-1
  plot(c(1:50),Sharkraytrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nsharks)
    for (i in 1:nsharks){lines(c(1:50),Sharkraytrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Sharkraytrends[1:nsharks,]), pch=3 , col=cl, bty='n')  

Inverttrends<-b0[fg$InvertsPlants==1,]/b0[fg$InvertsPlants==1,1]
    rownames(Inverttrends)<-fg$Functional.group[fg$InvertsPlants==1]
  Inverttrends["mean",]<-colMeans(b0[fg$InvertsPlants==1,]/b0[fg$InvertsPlants==1,1])
  ninverts<-length(Inverttrends$V1)-1
  plot(c(1:50),Inverttrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(ninverts)
    for (i in 1:ninverts){lines(c(1:50),Inverttrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Inverttrends[1:ninverts,]), pch=3 , col=cl, bty='n') 

#trends in species that start as CR
#CRtrends<- b0[fg$InvertsPlants==1,]/b0[fg$InvertsPlants==1,1]
    
```


 
 
```{r biomass plots}

#this will plot biomass, but not yet finished

par(mfrow=c(3,3)) #4 x 6 with 3 per graph should work

plot(c(1:50),(b0[4,]/b0[4,1]), ylim=c(0.6,1.4), type="l", col="black", ann=FALSE)
  lines(c(1:50),(b50[4,]/b50[4,1]),lty=2,col="black")
  lines(c(1:50),(b0[47,]/b50[47,1]),lty=1,col="red")
  lines(c(1:50),(b50[47,]/b50[47,1]),lty=2,col="red")
  title(ylab="% change in biomass", xlab="Years")
  legend(x="topright", c("birds 0 trawling", "birds 50%", "small demersal fish 0", "small demersal fish 0"), col=c("black", "black", "red", "red"), lty=c(1,2,1,2))




```


```{r Data out}

spp <- read.csv(file=paste0(lme[m],"/species_fin_3July17.csv"))

summarystats
fg.indicators
IndicatorGroups
Mammaltrends
Birdtrends
Fishtrends
Sharkraytrends
Inverttrends



```

