#biodiversity indicators 24/11/2015 Emily Nicholson
========================================================

## Species and analyses
To generate a 'true (model)' RLI 

For the RLI, we need the species to be linked to a FG to generate trends, a current threat RL status (or inferred), and a generation length for assessment.




```{r setup}
library(rdatacite)
library(taxize)
library(letsR) #this isn't working for my species lists?
library(rfishbase)
library(ggplot2)
library(dplyr)
library(plyr)
library(rredlist)
install.packages("devtools")
library(devtools)
# Install from main ZSL repository online
#install_github("Zoological-Society-of-London/rlpi", dependencies=TRUE)
library(rlpi) 

setwd("~/Documents/Papers in progress/Fisheries indicators/2014analyses/fisheries-indicators-Nov2014")

lme<-list("NthSea","Aleutians","Benguela","GulfCalif","China","GBR","Florida","NthAdriatic")
#make a list? either now or at the end
#template <- data.frame that I need to work out the structure for
#ll<-as.list(b0,b50,c0,c50)
#lme[[1]]<-ll
#str(lme[1])
#lme[1]<-list(b0=b0,b50=b50,c0=c0,c50=c50)
#is.list(lme)
#lme[1]<-b0
#nthsea["b0"",]

```


### Bring in data:  
1 species list  
2 functional group lists  
3 Ecopath scenarios   
  (no fg names, rows=fg by number, col=years starting at yr20 of simulation @policy implementation, transformed from ecopath output)  
1 biomass (EwE6-Ecosim_annual_biomass.csv  
2 trophic level (EwE6-Ecosim_annual_TL.csv)  
3 catch (EwE6-Ecosim_annual_yield.csv)  
4 landings (from files Alberto modified and sent: Landings discards areas 020513eveningAB-1)  

```{r import data}

m<-8
lme[m]

spp <- read.csv(file=paste0(lme[m],"/species_fin_6July17.csv")) 

fg <- read.csv(file=paste0(lme[m],"/functionalgroups.csv"))
# columns needed are named: fg  spp	RLI	RLstatus	GenLength	LPI
#spp$RLI<-spp$RLI*1
spp$RLI<-as.numeric(as.character(spp$RLI))
  #sum(spp$RLI, na.rm = TRUE)
spp$RLI[is.na(spp$RLI)]<-0  #d[is.na(d)] <- 0
spp$LPI<-as.numeric(as.character(spp$LPI))
  #sum(spp$LPI, na.rm = TRUE)
spp$LPI[is.na(spp$LPI)]<-0  #d[is.na(d)] <- 0

#see previous versions of file imports in Indicators24112015
#Biomass, catch, landings and trophic lengths per functional group, from Ecopath
startyear<-21 #this means starting at year 20, year before implementation

b0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_biomass.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  b0 <- b0[-nrow(b0),] #need to delete last row - an extra one is in the csv file
b50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_biomass.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  b50 <- b50[-nrow(b50),] #need to delete last row - an extra one is in the csv file
  
c0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_yield.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  c0 <- c0[-nrow(c0),] #need to delete last row - an extra one is in the csv file
c50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_yield.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  c50 <- c50[-nrow(c50),] #need to delete last row - an extra one is in the csv file

l0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/landings.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  #l0 <- l0[-nrow(l0),] #need to delete last row - an extra one is in the csv file
l50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/landings.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  #l50 <- l50[-nrow(l50),] #need to delete last row - an extra one is in the csv file

tl0 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort0/EwE6-Ecosim_annual_TL.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  tl0 <- tl0[-nrow(tl0),] #need to delete last row - an extra one is in the csv file
tl50 <- as.data.frame(t(read.table(file=paste0(lme[m],"/",lme[m],"_v2_effort50/EwE6-Ecosim_annual_TL.csv"), header=FALSE, sep=",", skip=startyear,nrows=50)))
  tl50 <- tl50[-nrow(tl50),] #need to delete last row - an extra one is in the csv file  

#write.table(tl0, file=paste0(lme[m],"/","tl0.csv"), sep=",", row.names = FALSE, col.names=FALSE)
#sum(l0-c0)

```



##RLI
Red List Index:
Gives a 'true' (all species) RLI and a 'sampled' RLI for the two scenarios (halt bottom trawling in solid lines, halving in dashed lines, where true=black and sample in red)

This currently just does mean inferred trends from RL status.
Need to add:
- uncertainty around inferred declines from status
- uncertainty from inferred status
- uncertainty from inferred generation length
- uncertainty for DD and NE species (and what status assumed to be)

**what threat status do we give to not-yet-redlisted species? That affects our starting point for the RLI values.
**can we use OHI code to pull range maps from the IUCN site to get the IUCN species as a starting list? Might add a few more species.
**can you get generation length via R from the IUCN website? Rather than the excel spreadsheet? Can we do the same from LPI to make it super up to date?



```{r RLI}
table(spp$RLstatus)

spp$timeframe <- pmax(10, pmin(round(3*spp$GenLength),100))   #asssessment timeframe
nspp<-length(spp$spp)#number of species
nreps<-500
RLItrue.0<-array(dim=c(nreps,5))
RLItrue.50<-RLItrue.0

RL.0.all<-array(data = 0, dim = c(nreps, nspp,5))
RL.50.all<-RL.0.all

#Find distribution of threat classes
#table(spp$RLstatus)
redlistedspp<-rbind(spp[spp$RLstatus=="CR",],spp[spp$RLstatus=="EN",],spp[spp$RLstatus=="VU",],spp[spp$RLstatus=="NT",],spp[spp$RLstatus=="LC",])
probs<-prop.table(table(redlistedspp$RLstatus))
probs2<-as.data.frame(probs)  #c(levels(probs2[,1]))
spp$RLstart<-spp$RLstatus

#for DD and NE species or any other category, draw from a 'distirbution' the same as table, set RLstart (assumed starting RL status) and repeat 100 times.

for (j in 1:nreps) {
#j<-1
DDspp<-sum((spp$RLstatus=="DD")*1)
spp$RLstart[spp$RLstatus=="DD"] <- sample(c(levels(probs2[,1])), DDspp, replace = TRUE, prob=probs)
NEspp<-sum((spp$RLstatus=="NE")*1)
spp$RLstart[spp$RLstatus=="NE"] <- sample(c(levels(probs2[,1])), NEspp, replace = TRUE, prob=probs)
prop.table(table(spp$RLstart))
  #tt<-sample(c(levels(probs2[,1])), 100, replace = TRUE, prob=probs)

RL.0<-array(data = 0, dim = c(nspp,5))  #array to store the RL values per species, halting trawling
rownames(RL.0)<-spp$sppid
RL.0[,1] <- ifelse(spp$RLstart=="CR",4,ifelse(spp$RLstart=="EN",3,ifelse(spp$RLstart=="VU",2,ifelse(spp$RLstart=="NT",1,0))))
RL.50 <- RL.0

#inferred median/mean? annual declines based on RL status 
InfDecl <- ifelse(RL.0[,1]==4,-0.9,ifelse(RL.0[,1]==3,-0.65,ifelse(RL.0[,1]==2,-0.4,ifelse(RL.0[,1]==1,-0.25,0))))/spp$timeframe
  #only needs one as starting status is the same for both scenarios

#===================================
# new species-based loop for RL status, needed as assessment year ie column) changes per species
for (i in 1:4) {
  #i<-1
  year<-i*10 #decadal intervals
  Btime0<-b0[spp$fg,year+1]  #Biomass at decadal intervals
  Btime50<-b50[spp$fg,year+1]
  for (sp in 1:nspp) {   
    #this calculates the decline over the species-specific timeframe based on generation length, and inferred decline from RL status 
    if (spp$timeframe[sp]>year) {
    InfBstart <- b0[spp$fg,1][sp]/(1+InfDecl[sp]*(spp$timeframe[sp]-year))
    Declat0 <- (Btime0[sp]-InfBstart)/InfBstart 
    Declat50 <- (Btime50[sp]-InfBstart)/InfBstart 
    } else {
    Bstart0 <- b0[spp$fg,year+1-spp$timeframe[sp]][sp]
    Declat0 <- (Btime0[sp]-Bstart0)/Bstart0
    Bstart50 <- b50[spp$fg,year+1-spp$timeframe[sp]][sp]
    Declat50 <- (Btime50[sp]-Bstart50)/Bstart50
    }
  RL.0[sp,i+1]<-ifelse(Declat0<=-0.8,4,ifelse(Declat0<=-0.5,3,ifelse(Declat0<=-0.3,2,ifelse(Declat0<=-0.2,1,0)))) #this estimates the RL status based on decline (ignoring other criteria)
  RL.50[sp,i+1]<-ifelse(Declat50<=-0.8,4,ifelse(Declat50<=-0.5,3,ifelse(Declat50<=-0.3,2,ifelse(Declat50<=-0.2,1,0))))
  }
}

#store these
RL.0.all[j,,]<-RL.0
RL.50.all[j,,]<-RL.50

#RLIs ===================
RLItrue.0[j,]<- 1-(colSums(RL.0)/(nspp*5))  #calculates the RLI 
RLItrue.50[j,]<- 1-(colSums(RL.50)/(nspp*5))

#RLIs<-c("true.0","true.50","sample.0", "sample.50")
#RLI <- array(dim=c(length(RLIs),nreps,5))
#rownames(RLI)<-RLIs
#RLI["true.0",j,] <-1-(colSums(RL.0)/(nspp*5))  #calculates the RLI 
#RLI["true.50",j,] <-1-(colSums(RL.50)/(nspp*5))
#RLI["sample.0",j,] <-1-colSums(RL.0[spp$RLI==1,])/(sum(spp$RLI)*5)
#RLI["sample.50",j,] <-1-colSums(RL.50[spp$RLI==1,])/(sum(spp$RLI)*5)

}  #end the reps to sample RL status at time 0

RLIs<-c("true.0","true.50","sample.0", "sample.50","sample.0.noDD","sample.50.noDD")
RLI <- array(dim=c(length(RLIs),5))
rownames(RLI)<-RLIs
RLI["true.0",] <-colMeans(RLItrue.0)  #calculates the mean RLI 
RLI["true.50",] <-colMeans(RLItrue.50)


##== pull out median and other examples ===============
RLItrue.0.medians <-RLItrue.0[RLItrue.0[,1]==median(RLItrue.0[,1]),]  #gets the median RLI 
RLItrue.0.medians[1,]
RLItrue.50.medians <-RLItrue.50[RLItrue.50[,1]==median(RLItrue.50[,1]),]  #gets the median RLI 
RLItrue.50.medians[1,]

RLI.true.0.median<-RL.0.all[RLItrue.0[,1]==median(RLItrue.0[,1]),,]
RLI.true.50.median<-RL.50.all[RLItrue.50[,1]==median(RLItrue.50[,1]),,]
RL.0.med<-RLI.true.0.median[1,,]
  rownames(RL.0.med)<-spp$sppid
RL.50.med<-RLI.true.50.median[1,,]
  rownames(RL.50.med)<-spp$sppid


#for all median RL values
#RLIvalues<-RL.0.all[RLItrue.0[,1]==median(RLItrue.0[,1]),,]

## Pull out RListed species having allocated DD based on median=====
RL.0.sample<-RL.0.med[spp$RLI==1,]
  rownames(RL.0.sample)<-spp$sppid[spp$RLI==1]
RL.50.sample<-RL.50.med[spp$RLI==1,]
  rownames(RL.50.sample)<-spp$sppid[spp$RLI==1]

RLI["sample.0",] <-1-colSums(RL.0.sample)/(nrow(RL.0.sample)*5)
RLI["sample.50",] <-1-colSums(RL.50.sample)/(nrow(RL.0.sample)*5)

## Pull out RListed species EXCLUDING DD SPP===== x & y 
#dim(RL.0.med[(spp$RLstatus!="DD"),])
RL.0.sample.noDD<-RL.0.med[(spp$RLI==1 & spp$RLstatus!="DD"),]
  rownames(RL.0.sample.noDD)<-rownames(RL.0.med[(spp$RLI==1 & spp$RLstatus!="DD"),])
RL.50.sample.noDD<-RL.50.med[(spp$RLI==1 & spp$RLstatus!="DD"),]
  rownames(RL.50.sample.noDD)<-rownames(RL.50.med[(spp$RLI==1 & spp$RLstatus!="DD"),])

RLI["sample.0.noDD",] <-1-colSums(RL.0.sample.noDD)/(nrow(RL.0.sample.noDD)*5)
RLI["sample.50.noDD",] <-1-colSums(RL.50.sample.noDD)/(nrow(RL.0.sample.noDD)*5)


#  other stuff

#pull out those starting values for RL
RLIvalues<-RL.0.all[RLItrue.0[,1]==median(RLItrue.0[,1]),,]
#dim(RLIvalues)
  spp$medianRLstart<-ifelse(RLIvalues[1,,1]==4,"CR",ifelse(RLIvalues[1,,1]==3, "EN",ifelse(RLIvalues[1,,1]==2, "VU",ifelse(RLIvalues[1,,1]==1, "NT","LC"))))
#table(redlistedspp$RLstatus)
table(spp$medianRLstart)
table(spp$RLstatus)
##== here would need to store the RL status per species to make a global RL
#lme[m]
#RL.0
#RL.50
#RLItrue.0.medians
#RLItrue.50.medians
#RL.0.all
#RL.50.all


  
```



```{r bootstrap RLI}
# Bootstrapping =================================
#currently just using the median value for true RLI, but need to pull out median RL starting values

#I think it best to do a quatile for CIs, e.g. 75%, and do bootstrapping to 75th on the 75ths of the uncertainty
  #I have not yet done this but it would be better

numboots<-100
RLIboots.sample.0<-array(dim=c(numboots,5))   #files for RLI
  RLIboots.sample.50<-array(dim=c(numboots,5))   #files for RLI
  RLIboots.med.0<-array(dim=c(numboots,5))   #files for RLI
  RLIboots.med.50<-array(dim=c(numboots,5))   #files for RLI  
  
for (bindex in 1:numboots) {

#bindex<-1

bootRLI <- sample(rownames(RL.0),replace=T)    #random list of sppids
bootRLIsample <- sample(rownames(RL.0.sample),replace=T)

#it wasn't working taking from RL.0 only because it was sampling all species, not just RListed species
    #RL.0.boot<-RL.0[bootRLI,]
    #RL.50.boot<-RL.50[bootRLI,]

RL.0.sample.boot<-RL.0.sample[bootRLIsample,]
RL.50.sample.boot<-RL.50.sample[bootRLIsample,]

RL.0.med.boot<-RL.0.med[bootRLI,]
RL.50.med.boot<-RL.50.med[bootRLI,]

RLIboots.sample.0[bindex,] <-1-colSums(RL.0.sample.boot)/(nrow(RL.0.sample.boot)*5)
RLIboots.sample.50[bindex,] <-1-colSums(RL.50.sample.boot)/(nrow(RL.50.sample.boot)*5)
RLIboots.med.0[bindex,] <-1-colSums(RL.0.med.boot[spp$RLI==1,])/(length(RL.0.med.boot[spp$RLI==1,1])*5)
RLIboots.med.50[bindex,] <-1-colSums(RL.50.med.boot[spp$RLI==1,])/(length(RL.50.med.boot[spp$RLI==1,1])*5)

} #end of bootstraps
  

#CIs from bootstraps ====

# get confidence intervals from bootstraps
    # here true = median 'true' sampling
RLIsCIs<-c("true.0.u","true.0.l","true.50.u","true.50.l","sample.0.u","sample.0.l", "sample.50.u","sample.50.l")
  RLI.CIs <- array(dim=c(length(RLIsCIs),5))
  rownames(RLI.CIs)<-RLIsCIs
lowerCI<-0.125  #for 95% CIs 0.025, for 90% 0.05, for 75% 0.125
upperCI<-0.875  #for 95% CIs 0.975, for 90% 0.95, for 75% 0.875

for (i in 1:5) {
  #i<-1
  RLI.CIs["true.0.l",i] = quantile(RLIboots.med.0[,i], lowerCI, names = FALSE) 
  RLI.CIs["true.0.u",i] = quantile(RLIboots.med.0[,i], upperCI, names = FALSE) 
  RLI.CIs["true.50.l",i] = quantile(RLIboots.med.50[,i], lowerCI, names = FALSE) 
  RLI.CIs["true.50.u",i] = quantile(RLIboots.med.50[,i], upperCI, names = FALSE)
  RLI.CIs["sample.0.l",i] = quantile(RLIboots.sample.0[,i], lowerCI, names = FALSE) 
  RLI.CIs["sample.0.u",i] = quantile(RLIboots.sample.0[,i], upperCI, names = FALSE) 
  RLI.CIs["sample.50.l",i] = quantile(RLIboots.sample.50[,i], lowerCI, names = FALSE) 
  RLI.CIs["sample.50.u",i] = quantile(RLIboots.sample.50[,i], upperCI, names = FALSE) 
}
  
  

```



```{r plot RLIs}


table(spp$RLstatus)
table(RL.0.med[,1])
table(RL.0.sample[,1])
#xx<-RL.0.sample[RL.0.sample[,1]==4,]


# plot them ==========================================
mini<-min(RLItrue.0,RLItrue.50, RLI)
maxi<-max(RLItrue.0,RLItrue.50,RLI)

plot(RLI["sample.0",], ylim=c(mini,maxi), type="l",col="red", ann=FALSE, lwd=2)
  lines(RLI["sample.50",],lty=2,col="red", lwd=2)
  lines(RLItrue.0.medians[1,],lty=1,col="black", lwd=2)
  lines(RLItrue.50.medians[1,],lty=2,col="black", lwd=2)
  lines(RLI["sample.50.noDD",],lty=2,col="blue")    #mean RLI
  lines(RLI["sample.0.noDD",],lty=1,col="blue")    #mean RLI
  title(ylab="RLI", xlab="Years")
  
plot(RLI["true.0",], ylim=c(mini,maxi), type="l",col="black", ann=FALSE)
  for (i in 1:nreps){lines(RLItrue.0[i,],lty=1,col = "lightgrey",lwd=0.2)}
  for (i in 1:nreps){lines(RLItrue.50[i,],lty=1,col = "lightgrey",lwd=0.2)}
  lines(RLItrue.0.medians[1,],lty=1,col="black", lwd=2)
  lines(RLItrue.50.medians[1,],lty=2,col="black", lwd=2)
  #lines(RLI["true.0",],lty=1,col="blue", lwd=2)  #means
  #lines(RLI["true.50",],lty=2,col="blue", lwd=2) #means
  lines(RLI["sample.0",],col="red", lwd=2)
  lines(RLI["sample.50",],lty=2,col="red", lwd=2)
  title(ylab="RLI", xlab="Years")

    #lines(RLItrue.0[1,], ylim=c(0.9,1), type="l",col="black", ann=FALSE)
  #lines(RLItrue.50[1,],lty=2,col="black")  
  
# plot bootstraps ===================================

# With CIs as fill for just halting
plot(RLI["sample.0",], ylim=c(mini,1), type="l",col="red",lwd=2, ann=FALSE)
polygon(c(1:5,rev(1:5)),c(RLI.CIs["sample.0.l",],rev(RLI.CIs["sample.0.u",])),density = 50,col = "pink", border = "red")
polygon(c(1:5,rev(1:5)),c(RLI.CIs["true.0.l",],rev(RLI.CIs["true.0.u",])),density = 50, col = "darkgrey", border = "black")
  lines( RLItrue.0.medians[1,],lty=1,col="black", lwd=2)
  lines(RLI["sample.0",],col="red", lwd=2)
  
  
png(filename = "NthSea/testplot.png")  
# With CIs as fill for all
plot(RLI["sample.0",], ylim=c(mini,maxi), type="l",col="red",lwd=2, ann=FALSE)
 polygon(c(1:5,rev(1:5)),c(RLI.CIs["sample.50.l",],rev(RLI.CIs["sample.50.u",])),density = 25,col = "pink", border = "red")
 polygon(c(1:5,rev(1:5)),c(RLI.CIs["true.50.l",],rev(RLI.CIs["true.50.u",])),density = 25, col = "darkgrey", border = "black") 
 polygon(c(1:5,rev(1:5)),c(RLI.CIs["sample.0.l",],rev(RLI.CIs["sample.0.u",])),density = 50,col = "pink", border = "red")
 polygon(c(1:5,rev(1:5)),c(RLI.CIs["true.0.l",],rev(RLI.CIs["true.0.u",])),density = 50, col = "darkgrey", border = "black")
    lines( RLItrue.0.medians[1,],lty=1,col="black", lwd=2)
    lines( RLItrue.50.medians[1,],lty=2,col="black", lwd=2)
    lines(RLI["sample.0",],col="red", lwd=2) 
    lines(RLI["sample.50",],lty=2,col="red", lwd=2)
dev.off()
  
  
```


 
 
```{r summary data}

# system, number of FGs, species, species in LPI, FGs in LPI, species in RLI, FGs in RLI, in MTI

LME<-lme[m]
nspp<-length(spp$spp) 
nfgs<-length(fg$FGnum)
LPIspp<-sum(spp$LPI)
  LPIfgs.list<- aggregate(spp$LPI, by = list(fg = spp$fg), FUN = sum, na.rm=TRUE)
LPIfgs <- sum(LPIfgs.list$x>0)
RLIspp<-sum(spp$RLI)
  RLIfgs.list<- aggregate(spp$RLI, by = list(fg = spp$fg), FUN = sum, na.rm=TRUE)
RLIfgs<-sum(RLIfgs.list$x>0)

tlmin <- 3.25
trueMTIfgs<-sum(fg$Include.in.MTI.*(fg$TL>=tlmin))
#landedMTIfgs<-sum(fg$LandedSpp*(fg$TL>=tlmin))
catchMTIfgs0<-sum((c0[3]>0)*(tl0[1]>=tlmin)*fg[,"Include.in.MTI."])
landedMTIfgs0<-sum((l0[3]>0)*(tl0[1]>=tlmin)*fg[,"Include.in.MTI."])

catchMTIfgs50<-sum((c50[3]>0)*(tl50[1]>=tlmin)*fg[,"Include.in.MTI."])
landedMTIfgs50<-sum((l50[3]>0)*(tl50[1]>=tlmin)*fg[,"Include.in.MTI."])

summarystats<-data.frame(LME,nspp,nfgs, LPIspp, LPIfgs, RLIspp, RLIfgs, trueMTIfgs, landedMTIfgs0, landedMTIfgs50,catchMTIfgs0,catchMTIfgs50)

# which functional groups are sampled? NOT FINISHED
#LPI.fgs<-unique(spp.sampleLPI.0$fg)
#Fgspp<-table(spp$fg)

#match name to FG, then add how many of each group there is
IndicatorFGS <- aggregate(spp$LPI, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    names(IndicatorFGS)[names(IndicatorFGS) == 'x'] <- 'LPI'
  RLIFGS <- aggregate(spp$RLI, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$RLI<-RLIFGS$x
  ModelFGS <- aggregate(spp$model, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$model<-ModelFGS$x
  allFGS <- aggregate(spp$model, by = list(fg = spp$fg, FGname = spp$FGname), FUN = sum, na.rm=TRUE)
    IndicatorFGS$model<-ModelFGS$x    
fg.indicators<-merge(fg, IndicatorFGS,  by.x='FGnum', by.y='fg', all.x=TRUE)


spp$bird <- fg$Birds[match(spp$fg,fg$FGnum)]
spp$fish <- fg$TeleostFish[match(spp$fg,fg$FGnum)]
spp$mammal <- fg$Mammals[match(spp$fg,fg$FGnum)]
spp$sharksrays <- fg$Elasmobranchs[match(spp$fg,fg$FGnum)]
spp$inverts <- fg$InvertsPlants[match(spp$fg,fg$FGnum)]

IndicatorGroups<-data.frame() #(all = 0, RLI = 0, LPI = 0, model = 0)
IndicatorGroups["bird","all"]<-sum(spp$bird)
  IndicatorGroups["bird","LPI"]<-sum(spp$bird*spp$LPI)
  IndicatorGroups["bird","RLI"]<-sum(spp$bird*spp$RLI)
  IndicatorGroups["bird","model"]<-sum(spp$bird*spp$model)
  IndicatorGroups["bird","fgs"]<-sum(fg$Birds)
IndicatorGroups["mammal",1:5]<-c(sum(spp$mammal),sum(spp$mammal*spp$LPI),sum(spp$mammal*spp$RLI), sum(spp$mammal*spp$model),sum(fg$Mammals)) 
IndicatorGroups["fish",1:5]<-c(sum(spp$fish),sum(spp$fish*spp$LPI),sum(spp$fish*spp$RLI), sum(spp$fish*spp$model),sum(fg$TeleostFish)) 
IndicatorGroups["sharksrays",1:5]<-c(sum(spp$sharksrays),sum(spp$sharksrays*spp$LPI),sum(spp$sharksrays*spp$RLI), sum(spp$sharksrays*spp$model),sum(fg$Elasmobranchs)) 
IndicatorGroups["inverts",1:5]<-c(sum(spp$inverts),sum(spp$inverts*spp$LPI),sum(spp$inverts*spp$RLI), sum(spp$inverts*spp$model),sum(fg$InvertsPlants)) 

barplot(as.matrix(t(IndicatorGroups[,1:3])), cex.lab = 1.5, cex.main = 1.4, beside=TRUE, horiz=TRUE, col=c("black","green", "red")) #red for RLI, green for LPI, black for all
#barplot(as.matrix(t(IndicatorGroups[,1:3])), cex.lab = 1.5, cex.main = 1.4, horiz=TRUE, col=c("black","green", "red"))

#biomass change yr40 relative to y1 for Fgs in this group
#IndicatorGroups["bird","changeB"]<-sum(spp$bird)

#df <- data.frame(x=rep(1:5, 9), val=sample(1:100, 45), 
                  # variable=rep(paste0("category", 1:9), each=5))
Birdtrends<-b0[fg$Birds==1,]/b0[fg$Birds==1,1]
    rownames(Birdtrends)<-fg$Functional.group[fg$Birds==1]
  Birdtrends["mean",]<-colMeans(b0[fg$Birds==1,]/b0[fg$Birds==1,1])
  nbirds<-length(Birdtrends$V1)-1
  plot(c(1:50),Birdtrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nbirds)
    for (i in 1:nbirds){lines(c(1:50),Birdtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Birdtrends[1:nbirds,]), pch=3 , col=cl, bty='n')  

Mammaltrends<-b0[fg$Mammals==1,]/b0[fg$Mammals==1,1]
    rownames(Mammaltrends)<-fg$Functional.group[fg$Mammals==1]
  Mammaltrends["mean",]<-colMeans(b0[fg$Mammals==1,]/b0[fg$Mammals==1,1])
  nmammals<-length(Mammaltrends$V1)-1
  plot(c(1:50),Mammaltrends["mean",], ylim=c(0.5,2.5), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nmammals)
    for (i in 1:nmammals){lines(c(1:50),Mammaltrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Mammaltrends[1:nmammals,]), pch=3 , col=cl, bty='n')  
  
Fishtrends<-b0[fg$TeleostFish==1,]/b0[fg$TeleostFish==1,1]
    rownames(Fishtrends)<-fg$Functional.group[fg$TeleostFish==1]
  Fishtrends["mean",]<-colMeans(b0[fg$TeleostFish==1,]/b0[fg$TeleostFish==1,1])
  nfish<-length(Fishtrends$V1)-1
  plot(c(1:50),Fishtrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nfish)
    for (i in 1:nfish){lines(c(1:50),Fishtrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Fishtrends[1:nfish,]), pch=3 , col=cl, bty='n')  

Sharkraytrends<-b0[fg$Elasmobranchs==1,]/b0[fg$Elasmobranchs==1,1]
    rownames(Sharkraytrends)<-fg$Functional.group[fg$Elasmobranchs==1]
  Sharkraytrends["mean",]<-colMeans(b0[fg$Elasmobranchs==1,]/b0[fg$Elasmobranchs==1,1])
  nsharks<-length(Sharkraytrends$V1)-1
  plot(c(1:50),Sharkraytrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(nsharks)
    for (i in 1:nsharks){lines(c(1:50),Sharkraytrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Sharkraytrends[1:nsharks,]), pch=3 , col=cl, bty='n')  

Inverttrends<-b0[fg$InvertsPlants==1,]/b0[fg$InvertsPlants==1,1]
    rownames(Inverttrends)<-fg$Functional.group[fg$InvertsPlants==1]
  Inverttrends["mean",]<-colMeans(b0[fg$InvertsPlants==1,]/b0[fg$InvertsPlants==1,1])
  ninverts<-length(Inverttrends$V1)-1
  plot(c(1:50),Inverttrends["mean",], ylim=c(0.5,2), xlim=c(0,40), type="l", col="black", lwd=3, ann=FALSE)
    cl <- rainbow(ninverts)
    for (i in 1:ninverts){lines(c(1:50),Inverttrends[i,],lty=1,col = cl[i])}
    legend("topleft", inset=c(0,0), legend=rownames(Inverttrends[1:ninverts,]), pch=3 , col=cl, bty='n') 

```


 
 
```{r biomass plots}

#this will plot biomass, but not yet finished

par(mfrow=c(3,3)) #4 x 6 with 3 per graph should work

plot(c(1:50),(b0[4,]/b0[4,1]), ylim=c(0.6,1.4), type="l", col="black", ann=FALSE)
  lines(c(1:50),(b50[4,]/b50[4,1]),lty=2,col="black")
  lines(c(1:50),(b0[47,]/b50[47,1]),lty=1,col="red")
  lines(c(1:50),(b50[47,]/b50[47,1]),lty=2,col="red")
  title(ylab="% change in biomass", xlab="Years")
  legend(x="topright", c("birds 0 trawling", "birds 50%", "small demersal fish 0", "small demersal fish 0"), col=c("black", "black", "red", "red"), lty=c(1,2,1,2))




```


```{r Data out}

spp <- read.csv(file=paste0(lme[m],"/species_fin_3July17.csv"))

summarystats
fg.indicators
IndicatorGroups
Mammaltrends
Birdtrends
Fishtrends
Sharkraytrends
Inverttrends



```

