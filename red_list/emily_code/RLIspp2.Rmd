Title
========================================================

I have a list of species names (which may expand or change, plus another 7 lists).   

From Catalogue of Life, I would like to get all the synonyms, and the most correct nomenclature.  

From Fishbase I'd like to get synonmyms as well, and also a range of variables such as Linf... longevity... not sure what they have.

```{r set up and import data}
library(rdatacite)
library(taxize)
library(letsR) #this isn't working for my species lists?
library(rfishbase)
library(ggplot2)
library(dplyr)
library(plyr)
library(rredlist)
library(githubinstall)
#githubinstall("rfishbase")
library(rfishbase)


setwd("~/Documents/Papers in progress/Fisheries indicators/2014analyses/fisheries-indicators-Nov2014")

RLspeciessynonyms<-read.csv("RLdata/RLmarinesppNov2015syn.csv")
RLspecies<-read.csv("RLdata/RLmarinesppNov2015.csv")
genlengths<-read.csv("RLdata/NCEASGenerationlengths.csv")
MammalGL <-read.csv("RLdata/GenLengthMammalsPacifici.csv")
LPIlist<-read.csv("RLdata/LPI_LPR2016data_public.csv")

NthSeaSpp <- read.csv("GulfCalif/species_raw.csv")
#NthSeaSpp <- read.csv("NthAdriatic/species_6July17.csv")

natmort <-read.csv("GulfCalif/naturalmortality_Calif.csv")

#RLspp.all <- read.csv("RLspp-all-20Nov2014.csv")
#spp.names <- paste(RLspp.all$Genus,RLspp.all$Species)
#RLspp.all3 <- RLspp.all[,c(1,8,10,11,14,15,17,18)]  
#RLspp.all3$Species <- spp.names
#NthSea.spplist <- read.csv("NthSea/species.all.csv")
#lme<-list("NthSea","Aleutians","Benguela","GulfCalif","China","GBR","Florida","NthAdriatic")
#i<-1
#spp <- read.csv(file=paste0(lme[i],"/specieslist.csv"))
#NthSea.spplist <- read.csv("NthSea/species.all.csv") #this is the master list, somewhat incomplete still for RL

```



Useful newdata <- mydata[ which(mydata$gender=='F' & mydata$age > 65), ]
http://www.statmethods.net/management/subset.html

To do:
tidy up the files
find a better way than merge of matching them
To keep colums: df <- subset(df, select = c(a,c))
to delete columns: df <- subset(df, select = -c(a,c) )

```{r name matching and data clean and RL status sheck}


NthSeaSpp$matched <- NthSeaSpp$SppName %in% RLspecies$Species #checks if on IUCN species list
#Need to get IUCN status and check if the same



## RL checks ==============
# RL API fc6988cec4197fdc5939f7c7002ece0032e1c018ba63739d3cdfd666a1940932
IUCN_REDLIST_KEY<-"fc6988cec4197fdc5939f7c7002ece0032e1c018ba63739d3cdfd666a1940932"

for (spp in 1:nrow(NthSeaSpp) ) {
myspp <- as.character(NthSeaSpp$SppName[spp])
if (is.na(iucn_id(sciname = myspp, key = IUCN_REDLIST_KEY))) {
  NthSeaSpp$RLstatus2[spp] <- "NE"
  NthSeaSpp$RLI2[spp] <-0
  } else {
  rrr<-rl_search(name = myspp, key = IUCN_REDLIST_KEY, parse = FALSE)
  NthSeaSpp$RLstatus2[spp] <- rrr$result[[1]]$category
  NthSeaSpp$RLI2[spp] <-1
  }
}


## LPI checks ===============
#check against latest LPI list?? 
LPIlist$SppName<-paste(LPIlist$Genus, LPIlist$Species)
NthSeaSpp$LPIcheck <- (NthSeaSpp$SppName %in% LPIlist$SppName)*1 #checks if on LPI species list
NthSeaSpp$LPIcheck2 <- (NthSeaSpp$Synonym %in% LPIlist$SppName)*1 #checks if on LPI species list
NthSeaSpp$LPI2 <- pmax(NthSeaSpp$LPIcheck,NthSeaSpp$LPIcheck2)

#sum(NthSeaSpp$LPIcheck)

write.csv(NthSeaSpp, "GulfCalif/speciescheck.csv", row.names = FALSE)


## individual species checks =================

myspp2<-"Echinus esculentus"
myspp2 %in% LPIlist$SppName
rl_search(name = myspp2, key = IUCN_REDLIST_KEY, parse = FALSE)

myspp_common <-"bottlenose dolphin"
myspp_common %in% LPIlist$Common_name
LPIlist[LPIlist$Common_name=="myspp_common",]



```



```{r first go gen length}


#NthSeaSpp$matchgen <- NthSeaSpp$SppName %in% genlengths$Species

MammalGL$GLy<-MammalGL$GenerationLength_d/365

#get known gen lengths
NthSeaSpp_GL <- merge(NthSeaSpp,  genlengths, by.x='SppName', by.y='Species', all.x=TRUE)

#rule for which GL - use IUCN first, fill gaps with NCEAS, all known become NA
#NthSeaSpp_GL$GenLK <- as.numeric(levels(NthSeaSpp_GL$GenL))[NthSeaSpp_GL$GenL] #this isn't working anymore

NthSeaSpp_GL$GenLK <- round(ifelse(is.na(NthSeaSpp_GL$GenL),NthSeaSpp_GL$Gen_len,NthSeaSpp_GL$GenL),1)

NthSeaSpp_GL2 <- merge(NthSeaSpp_GL,  MammalGL, by.x='SppName', by.y='Scientific_name', all.x=TRUE)
NthSeaSpp_GL2$GenLK2 <- round(ifelse(is.na(NthSeaSpp_GL2$GenLK),NthSeaSpp_GL2$GLy,NthSeaSpp_GL2$GenLK),1)

###generation length from the IUCN data, but I manually added the 3-4 species in the nth Sea for which we didn't have GL already
NthSeaSpp_GL3 <- merge(NthSeaSpp_GL,  RLspecies, by.x='SppName', by.y='Species', all.x=TRUE)
#NthSeaSpp_GL3$Generation.length

#now need to calculate generation lengths if not known
sum(is.na(NthSeaSpp_GL2$GenLK2))/length(NthSeaSpp_GL2$GenLK2)



#sum <- aggregate(data[, c(5:154)], by = list(site = data$site, plot = data$plot), FUN = sum)


write.csv(NthSeaSpp_GL2, file="Aleutians/sppGL2.csv", row.names=FALSE)



#write.csv(sum, "points_aerial_summed.csv", row.names = FALSE)



```

# To do
I am getting maturity from fishbase for those who have it. 
I need to: 
1. many species do not have this data, and I may need ot use length parameters.
2. get similar data from sealife for non-fish.

3. combine this with the mortality as per IUC rules to estimate GenLength

4. Make another rule for those species for which we have no Gen Lgnth

Not sure this is a problem: check: problem is when error messages come up including synonyms (where different species name for RL and fishbase). Can I use the name check instead?

Data cleaning: it works for the Nth Sea list. need to make sure that all species have two names (not 1 (eg genus) or 3)


Fishbase
```{r fishbasing}

#myspecies <- NthSeaSpp$SppName[1] #Cetorhinus maximus, basking shark
#myspecies <- c("Cetorhinus maximus","Squalus acanthias")
#myspecies <- "Sterna hirundo"
#fishbase
#common_names(myspecies)
#myspecies <- "Cetorhinus maximus"

#NthSeaSpp_GL2$maturity<-0

#validate_names(NthSeaSpp$SppName) can only do fish!

#NthSeaSpp_GL2$maturityold<- NthSeaSpp_GL2$maturity #this was the one based on TL estiamte rather than tm
options(FISHBASE_API = "https://fishbase.ropensci.org")

#get maturity from fishbase
for (spp in 1:nrow(NthSeaSpp_GL2)) {
  #spp<-1
if (is.na(NthSeaSpp_GL2$GenLK2[spp])) {
  #if we have a gen length already not to worry 
  myspecies<-as.character(NthSeaSpp_GL2$SppName[spp])
  namecheck<-validate_names(myspecies)
  if (is.character(namecheck)==TRUE) {
    maturitydatacheck<-sum(is.na(maturity(myspecies)))
    if (maturitydatacheck>0) {
      xx<-maturity(myspecies, fields = "tm")
      xxx<-maturity(myspecies, fields = c("AgeMatMin", "AgeMatMin2"))
      ifelse(sum(xx/xx, na.rm = TRUE)>0, 
             NthSeaSpp_GL2$maturity[spp] <- sum(xx, na.rm = TRUE)/sum(xx/xx, na.rm = TRUE),
             ifelse(sum(xxx/xxx, na.rm = TRUE)>0,
                    NthSeaSpp_GL2$maturity[spp] <- sum(xxx, na.rm = TRUE)/sum(xxx/xxx, na.rm = TRUE),
                    NthSeaSpp_GL2$maturity[spp]<-NA))
      #ifelse it is NA then try the old one
      } else {NthSeaSpp_GL2$maturity[spp]<-NA}
  } else {NthSeaSpp_GL2$maturity[spp]<-NA}
} else {NthSeaSpp_GL2$maturity[spp]<-NA}
}


#arrange(test,FGnum)
#sum(NthSeaSpp_GL2$maturity/NthSeaSpp_GL2$maturity, na.rm = TRUE)

#myspecies <- "Raja clavata"
#maturity(myspecies)
#xxx<-maturity(myspecies, fields = "tm")
#sum(xxx, na.rm = TRUE)/sum(xxx/xxx, na.rm = TRUE)

#mean(xxx, na.rm = TRUE)
#maturity(myspecies, fields = c("AgeMatMin", "AgeMatMin2"))

#yy<-maturity(myspecies)
#sum(is.na(yy))

#reproduction(myspecies)
#species_fields


#namecheck<-validate_names('Abra prismatica')
#test<-validate_names(c("Cetorhinus maximus","Squalus acanthias","Sterna hirundo"))
#test2<-c("Cetorhinus maximus","Squalus acanthias","Sterna hirundo","Cetorhinus maximus")
#test3<-validate_names(test2)

#validate_names("Sterna hirundo")
#"Cetorhinus maximus" %in% fishbase$
#species(c("Cetorhinus maximus",myspecies))

#maturity(myspecies)  #can't get this to average over it, but can do some manually??
#xx<-maturity("Cetorhinus maximus", fields = c("AgeMatMin", "AgeMatMin2"))
#xx<-maturity(myspecies, fields = c("AgeMatMin", "AgeMatMin2"))
#mean(xx, na.rm = TRUE)
#mean(xx[1,])
#xx[2,1]+xx[2,2]
# gives av maturity sum(xx, na.rm = TRUE)/sum((is.na(xx)*1))


```
Hitting a problem where some species, though in the database, aren't searching properly???

```{r sealifebase}


#run it all through sealife
options(FISHBASE_API = "https://fishbase.ropensci.org/sealifebase")
myspecies2<-"Rossia macrosoma"
validate_names(myspecies2)
#reproduction(myspecies2)

#validate_names("Carcinus maenas", server = "https://fishbase.ropensci.org/sealifebase")

### something not working with species:
  # North Sea: 321, 322, 323
  # Aleutians: 246
  # NthAdriatic: 264


for (spp in 1:nrow(NthSeaSpp_GL2)) {
  #spp<-264
if (is.na(NthSeaSpp_GL2$GenLK2[spp])) {
  #if we have a gen length already not to worry 
  # if we have a maturity not to worry
#if (is.na(NthSeaSpp_GL2$maturity[spp])) {
  myspecies<-as.character(NthSeaSpp_GL2$SppName[spp])
  namecheck<-validate_names(myspecies)
  if (is.character(namecheck)==TRUE) {
    maturitydatacheck<-sum(is.na(maturity(myspecies, server = "https://fishbase.ropensci.org/sealifebase")))
    if (maturitydatacheck>0) {
      xx<-maturity(myspecies, fields = "tm")
      xxx<-maturity(myspecies, fields = c("AgeMatMin", "AgeMatMin2"))
      ifelse(sum(xx/xx, na.rm = TRUE)>0, 
             NthSeaSpp_GL2$maturity2[spp] <- sum(xx, na.rm = TRUE)/sum(xx/xx, na.rm = TRUE),
             ifelse(sum(xxx/xxx, na.rm = TRUE)>0,
                    NthSeaSpp_GL2$maturity2[spp] <- sum(xxx, na.rm = TRUE)/sum(xxx/xxx, na.rm = TRUE),
                    NthSeaSpp_GL2$maturity2[spp]<-NA))
      #ifelse it is NA then try the old one
      } else {NthSeaSpp_GL2$maturity2[spp]<-NA}
  } else {NthSeaSpp_GL2$maturity2[spp]<-NA}
#} else {NthSeaSpp_GL2$maturity[spp]<-NthSeaSpp_GL2$maturity[spp]}
} else {NthSeaSpp_GL2$maturity2[spp]<-NA} 
}
options(FISHBASE_API = "https://fishbase.ropensci.org")





```

```{r gen length calcultions}



NthSeaSpp_GL4 <- merge(NthSeaSpp_GL2,  natmort, by.x='FGnum', by.y='Fgnum', all.x=TRUE)
NthSeaSpp_GL4$GenLenfishbase <- 1/NthSeaSpp_GL4$M +  NthSeaSpp_GL4$maturity

#write.csv(NthSeaSpp_GL2, file="NthSea/NthSea.GL2.12April2017sealife.csv", row.names=FALSE)

NthSeaSpp_GL4$GenLKfin <- round(ifelse(is.na(NthSeaSpp_GL4$GenLK2),NthSeaSpp_GL4$GenLenfishbase,NthSeaSpp_GL4$GenLK2),1)

#for NTH Sea this gives half of species
sum(is.na(NthSeaSpp_GL4$GenLKfin))/length(NthSeaSpp_GL4$GenLKfin)

FGmeanGL <- aggregate(NthSeaSpp_GL4$GenLKfin, by = list(Fgnum = NthSeaSpp_GL4$FGnum), FUN = mean, na.rm=TRUE)

Species_GL5 <- merge(NthSeaSpp_GL4,  FGmeanGL, by.x='FGnum', by.y='Fgnum', all.x=TRUE)
Species_GL5$Genlfinal<-round(ifelse(is.na(Species_GL5$GenLKfin),Species_GL5$x,Species_GL5$GenLKfin),1)
sum(is.na(Species_GL5$Genlfinal))/length(Species_GL5$Genlfinal)

Species_GL5$Genlfinal<-ifelse(is.na(Species_GL5$Genlfinal),3.3,Species_GL5$Genlfinal)

Species_final <-Species_GL5[,c("sppid", "FGnum", "SppName","FGname","CommonName","RLI2","RLstatus2","LPI2","Genlfinal","Named.in.model")]


Species_final <- rename(Species_final, c("FGnum" = "fg", "SppName" = "spp", "RLI2" = "RLI", "RLstatus2" = "RLstatus", "LPI2" = "LPI", "Genlfinal" = "GenLength", "Named.in.model" = "model"))

write.csv(Species_final, file="GulfCalif/species_fin_13July17.csv", row.names=FALSE)



```



```{r old code}

#qplot(NthSeaSpp_GL2$GenLK2)

#NthSeaSpp_GL$GenLK <- NthSeaSpp_GL$GenL   #df[df==""]<-NA
#NthSeaSpp_GL$GenLK <- as.numeric(levels(NthSeaSpp_GL$GenLK))[NthSeaSpp_GL$GenLK]

#test <- ifelse(is.na(NthSeaSpp_GL$GenLK),0,NthSeaSpp_GL$GenLK)

#IUCNgl <- length(NthSeaSpp_GL$GenLK)-sum(is.na(as.numeric(levels(NthSeaSpp_GL$GenL))[NthSeaSpp_GL$GenL])) #from IUCN
#length(NthSeaSpp_GL$GenLK)-sum(is.na(NthSeaSpp_GL$GenLK))
# the number that had a generation length assigned - not many!
#NthSeaSpp_GL2$GenLK2 <- round(ifelse(is.na(NthSeaSpp_GL2$GenLK),NthSeaSpp_GL2$GLy,NthSeaSpp_GL2$GenLK),1)
#t<-is.na(NthSeaSpp_GL2$GenLK)
#tt<-t*1


x<-"Lycaon Pictus"
aa <-"Tursiops truncatus"
lets.iucn(aa)
lets.iucn("Atyoida bisulcata")
y<-c("Lycaon Pictus","Pygscelis papua")

#lets.iucn(y)
lets.iucn.his(x)


#testing matching functions
sp3<-"Leucoraja fullonica"
sp<-"Micromesistius poutassou"
sp2<-"raja fullonica"
sp4<-"Merlangius merlangus"
sp5<-"Gelochelidon nilotica"
sp6<-"Sterna nilotica"

synonyms(sp5,db='ubio')
synonyms(sp5,db='itis')
aaa<-synonyms(sp4,db='ubio')
aaaa<-synonyms(sp4,db='ubio')
iucn_getname(sp5)
iucn_summary(sp5)
get_colid(sp)
col_search(name=sp5)
eol_search(sp5)

gnr_resolve(sp5)
get_tsn(sp5, searchtype = "scientific", accepted = FALSE, ask = TRUE, verbose = TRUE)

iucn_summary(NthSea.spplist$species[1:10])

RLstat<-iucn_summary(NthSea.spplist$species[1:10])
RLstat[[2]][1] #RL status for each species
RLstat[[2]]$status  #RL status for each species

spp.syn<-synonyms(NthSea.spplist$species,db='itis')

spp.syn[1] #gets the species
spp.syn[[1]] #gets the data inside the spp
spp.syn[[1]][[1]] #gets the first name of the species

write.table(spp.syn,file="NthSea/NthSea.syn.txt", sep="\t", row.names=TRUE, col.names=TRUE)




##old stuff I haven't gone through
NthSeaSpp$SppName.Model[1]
RLspecies$Species[7328]
ttt<-pmatch(NthSea.spplist$species,RLspp.all3$Synonyms)
NthSea.spplist$species.m <- RLspp.all3$Species[tt]
NthSea.spplist$species.msyn <- RLspp.all3$Species[ttt]
NthSea.spplist$RLstatus.m <- RLspp.all3$Red.List.status[tt]
#NthSea.spplist$RLstatus.m2 <- RLspp.all3$Red.List.status[ttt]
NthSea.spplist$RLcriteria.m <- RLspp.all3$Red.List.criteria[tt]

#match Genlength
gg<-match(NthSea.spplist$species,spp$spp)
ggg<-pmatch(NthSea.spplist$species,spp$spp)
NthSea.spplist$spp.m2 <- spp$spp[gg]
aa <- spp$GenLength[gg]
bb <- spp$GenLength[ggg]
NthSea.spplist$genlength <- ifelse(aa>0,aa,ifelse(bb>0,bb,NthSea.spplist$GenLength))


#match Genlength with NCEAS file
gg<-match(NthSea.spplist$species,genlengths$Species)
ggg<-match(NthSea.spplist$Synonym,genlengths$Species)
NthSea.spplist$spp.m2 <- genlengths$Species[gg]
NthSea.spplist$spp.m3 <- genlengths$Species[ggg]
aa <- genlengths$Gen_len[gg]
bb <- genlengths$Gen_len[ggg]
NthSea.spplist$genlength2 <- aa
NthSea.spplist$genlength3 <- bb
#NthSea.spplist$genlength4 <- ifelse(aa=="NA",bb,aa)
#NthSea.spplist$genlength4 <- ifelse(aa>0,aa,bb)

write.table(NthSea.spplist, file="NthSea/NthSea.match.txt", sep="\t", row.names=TRUE, col.names=TRUE)


#pmatch(NthSea.spplist$Synonym[12],spp$spp[120])




```

